<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>TransmitSMS: Configure Action Service</title>

    <link href="/eloqua-service/assets/css/bootstrap.min.css" rel="stylesheet">
    <link href="/eloqua-service/assets/css/main.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/vue-select@3.0.0/dist/vue-select.css">
    <style type="text/css">
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      
      @keyframes fadeIn {
        from { 
          opacity: 0; 
          transform: translateY(-10px); 
        }
        to { 
          opacity: 1; 
          transform: translateY(0); 
        }
      }

      @keyframes fadeOut {
        from { 
          opacity: 1; 
          transform: translateY(0);
        }
        to { 
          opacity: 0; 
          transform: translateY(-10px);
        }
      }
      
      .spinner {
        border: 3px solid #f3f3f3;
        border-top: 3px solid #4CAF50;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        animation: spin 1s linear infinite;
        display: inline-block;
        margin-right: 10px;
      }

      .spinner-sm {
        width: 16px;
        height: 16px;
        border-width: 2px;
        margin-right: 5px;
        vertical-align: middle;
      }

      .two-column-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 15px;
      }

      .two-column-row .column-left {
        width: 48%;
      }

      .two-column-row .column-right {
        width: 48%;
      }

      .full-width {
        width: 100%;
        margin-bottom: 15px;
      }

      .form-control {
        width: 100%;
        height: 30px;
        padding: 5px 12px;
        font-size: 14px;
        line-height: 1.42857143;
        color: #555;
        background-color: #fff;
        border: 1px solid #ccc;
        border-radius: 4px;
      }

      .form-control:focus {
        border-color: #66afe9;
        outline: 0;
        box-shadow: inset 0 1px 1px rgba(0,0,0,.075), 0 0 8px rgba(102,175,233,.6);
      }

      .form-group {
        margin-bottom: 15px;
      }

      label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
        font-size: 14px;
      }

      .alert {
        padding: 15px;
        margin-bottom: 20px;
        border: 1px solid transparent;
        border-radius: 4px;
        position: relative;
        animation: fadeIn 0.3s ease-out;
      }

      .alert.fade-out {
        animation: fadeOut 0.3s ease-out forwards;
      }

      .alert-success {
        color: #3c763d;
        background-color: #dff0d8;
        border-color: #d6e9c6;
      }

      .alert-danger {
        color: #a94442;
        background-color: #f2dede;
        border-color: #ebccd1;
      }

      .alert-info {
        color: #31708f;
        background-color: #d9edf7;
        border-color: #bce8f1;
      }

      .alert.fade {
        opacity: 0;
        transition: opacity 0.3s ease-out;
      }

      .alert.fade.in {
        opacity: 1;
      }

      .alert .close {
        float: right;
        font-size: 21px;
        font-weight: bold;
        line-height: 1;
        color: #000;
        text-shadow: 0 1px 0 #fff;
        opacity: .2;
        background: transparent;
        border: 0;
        cursor: pointer;
        padding: 0;
        margin: -5px -10px 0 0;
      }

      .alert .close:hover {
        opacity: .5;
      }

      .btn {
        display: inline-block;
        padding: 6px 12px;
        margin-bottom: 0;
        font-size: 14px;
        font-weight: normal;
        line-height: 1.42857143;
        text-align: center;
        white-space: nowrap;
        vertical-align: middle;
        cursor: pointer;
        border: 1px solid transparent;
        border-radius: 4px;
      }

      .btn-default {
        color: #333;
        background-color: #fff;
        border-color: #ccc;
      }

      .btn-default:hover {
        color: #333;
        background-color: #e6e6e6;
        border-color: #adadad;
      }

      .btn-default:disabled {
        opacity: 0.65;
        cursor: not-allowed;
      }

      .btn-success {
        color: #fff;
        background-color: #28a745;
        border-color: #28a745;
      }

      .btn-success:hover {
        background: #218838;
        border-color: #1e7e34;
      }

      textarea.form-control {
        height: auto;
        padding: 8px 12px;
      }

      .merge-toolbar {
        display: flex;
        flex-direction: column;
        gap: 10px;
        margin-bottom: 10px;
        padding: 10px;
        background: #f9f9f9;
        border: 1px solid #ddd;
        border-radius: 4px;
      }

      .merge-toolbar-row {
        display: flex;
        gap: 15px;
        align-items: flex-end;
      }

      .merge-section {
        display: flex;
        flex-direction: column;
      }

      .merge-section label {
        font-size: 11px;
        font-weight: bold;
        margin-bottom: 3px;
        text-align: left;
      }

      .merge-section select,
      .merge-section .v-select {
        height: 27px !important;
        font-size: 11px;
      }

      .merge-section select {
        padding: 2px 6px;
      }

      .merge-section .v-select .vs__dropdown-toggle {
        min-height: 27px;
        height: 27px;
        padding: 0 6px;
      }

      .merge-section .v-select .vs__selected-options {
        padding: 0;
        min-height: 25px;
      }

      .merge-section .v-select .vs__selected {
        font-size: 11px;
        line-height: 25px;
        margin: 0;
        padding: 0 2px;
      }

      .merge-section .v-select .vs__search {
        font-size: 11px;
        line-height: 25px;
        margin: 0;
        padding: 0 2px;
      }

      .merge-section .v-select .vs__actions {
        padding: 0 3px;
      }

      .merge-section .v-select input {
        height: 25px;
      }

      .label-with-checkbox {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 5px;
      }

      .label-with-checkbox label {
        margin: 0;
      }

      .label-with-checkbox .checkbox-wrapper {
        display: flex;
        align-items: center;
        gap: 5px;
      }

      .label-with-checkbox .checkbox-wrapper label {
        font-weight: normal;
        font-size: 12px;
      }

      .merge-focus-indicator {
        font-size: 10px;
        color: #28a745;
        font-weight: bold;
        margin-left: 10px;
        padding: 2px 6px;
        background: #d4edda;
        border-radius: 3px;
      }

      .test-sms-section {
        padding: 15px;
        background: #f9f9f9;
        border: 1px solid #ddd;
        border-radius: 4px;
        margin-bottom: 15px;
      }

      .test-sms-section h5 {
        margin: 0 0 15px 0;
        font-size: 14px;
        font-weight: bold;
        color: #333;
      }

      .test-status {
        padding: 10px 15px;
        margin-top: 15px;
        border-radius: 4px;
        font-size: 13px;
        animation: fadeIn 0.3s ease-out;
      }

      .test-status.success {
        background-color: #d4edda;
        border: 1px solid #c3e6cb;
        color: #155724;
      }

      .test-status.error {
        background-color: #f8d7da;
        border: 1px solid #f5c6cb;
        color: #721c24;
      }

      .test-status strong {
        display: block;
        margin-bottom: 5px;
      }

      .test-status-details {
        font-size: 12px;
        margin-top: 8px;
        padding-top: 8px;
        border-top: 1px solid rgba(0,0,0,0.1);
      }

      .test-status-details div {
        margin: 3px 0;
      }

      .cdo-mapping-box {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        padding: 15px;
        margin-bottom: 15px;
      }

      .cdo-mapping-box h5 {
        margin: 0 0 15px 0;
        font-size: 15px;
        font-weight: bold;
        color: #495057;
        border-bottom: 2px solid #dee2e6;
        padding-bottom: 8px;
      }

      .cdo-field-row {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px solid #e9ecef;
        font-size: 13px;
      }

      .cdo-field-row:last-child {
        border-bottom: none;
      }

      .cdo-field-label {
        font-weight: 600;
        color: #6c757d;
        flex: 0 0 40%;
      }

      .cdo-field-value {
        color: #212529;
        flex: 1;
        text-align: right;
        font-family: 'Courier New', monospace;
      }

      .cdo-no-config {
        text-align: center;
        color: #6c757d;
        font-style: italic;
        padding: 10px;
      }

      .cdo-name {
        background: #007bff;
        color: white;
        padding: 8px 12px;
        border-radius: 4px;
        margin-bottom: 15px;
        font-size: 13px;
        font-weight: bold;
      }

      .report-btn-wrapper {
        text-align: center;
        margin: 20px 0;
        padding: 15px;
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 4px;
      }

      .btn-report {
        padding: 12px 35px;
        font-size: 16px;
        font-weight: bold;
        background: #28a745;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }

      .btn-report:hover {
        background: #218838;
      }

      .report-section {
        background: #fff;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        padding: 15px;
        margin-bottom: 15px;
      }

      .report-section h5 {
        margin: 0 0 15px 0;
        font-size: 15px;
        font-weight: bold;
        color: #495057;
        border-bottom: 2px solid #dee2e6;
        padding-bottom: 8px;
      }

      /* ‚úÖ UPDATED: Support 5 cards */
      .report-stats {
        display: flex;
        justify-content: space-around;
        gap: 10px;
        margin-bottom: 15px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 4px;
      }

      .stat-card {
        text-align: center;
        flex: 1;
        min-width: 80px;
      }

      /* ‚úÖ UPDATED: Smaller font for 5 cards */
      .stat-card .stat-number {
        font-size: 28px;
        font-weight: bold;
        color: #007bff;
        display: block;
      }

      /* ‚úÖ UPDATED: Smaller label for 5 cards */
      .stat-card .stat-label {
        font-size: 11px;
        color: #6c757d;
        text-transform: uppercase;
        margin-top: 5px;
        display: block;
      }

      .stat-card.sent .stat-number {
        color: #007bff;
      }

      .stat-card.delivered .stat-number {
        color: #28a745;
      }

      /* ‚úÖ NEW: Bounced color (orange) */
      .stat-card.bounced .stat-number {
        color: #fd7e14;
      }

      .stat-card.failed .stat-number {
        color: #dc3545;
      }

      .stat-card.pending .stat-number {
        color: #ffc107;
      }

      .loading-spinner {
        text-align: center;
        padding: 20px;
        color: #6c757d;
      }

      .report-actions {
        text-align: center;
        padding-top: 10px;
        border-top: 1px solid #dee2e6;
      }
    </style>
  </head>
  <body>
    <div id="sendsmsaction" class="container" style="width: 600px; padding: 20px;">
      <form method="post">
        <h4 style="font-size: 20px; font-weight: bold; text-align: center; margin-bottom: 20px;">
          <img src="/eloqua-service/assets/images/send-sms-el-icon.png" onerror="this.style.display='none'" style="vertical-align: middle;">&nbsp;Create your Text Message
        </h4>

        <!-- Row 1: Sender ID (LEFT) | Recipient Field (RIGHT) -->
        <div class="two-column-row">
          <div class="column-left">
            <div class="form-group">
              <label>Sender ID</label>
              <select v-model="instance.caller_id" class="form-control" :disabled="loadingSenderIds">
                <option value="">{{ loadingSenderIds ? 'Loading...' : 'Default' }}</option>
                <optgroup v-if="sender_ids['Virtual Number'] && sender_ids['Virtual Number'].length" label="Virtual Number">
                  <option v-for="number in sender_ids['Virtual Number']" v-bind:value="number" :key="'vn-' + number">{{ number }}</option>
                </optgroup>
                <optgroup v-if="sender_ids['Business Name'] && sender_ids['Business Name'].length" label="Business Name">
                  <option v-for="number in sender_ids['Business Name']" v-bind:value="number" :key="'bn-' + number">{{ number }}</option>
                </optgroup>
                <optgroup v-if="sender_ids['Mobile Number'] && sender_ids['Mobile Number'].length" label="Mobile Number">
                  <option v-for="number in sender_ids['Mobile Number']" v-bind:value="number" :key="'mn-' + number">{{ number }}</option>
                </optgroup>
                <optgroup label="Contact Fields">
                  <option v-for="field in fields" v-bind:value="'##' + field.internalName" :key="'f-' + field.internalName">{{ field.name }}</option>
                </optgroup>
              </select>
            </div>
          </div>
          <div class="column-right">
            <div class="form-group">
              <label>Recipient Field</label>
              <select v-model="instance.recipient_field" class="form-control">
                  <option v-for="field in fields" v-bind:value="field.id ? field.id + '__' + field.internalName : field.internalName" :key="'rec-' + field.internalName">
                      {{ field.name }}
                  </option>
              </select>
            </div>
          </div>
        </div>

        <!-- Row 2: Country Field (Full Width) -->
        <div class="full-width">
          <div class="form-group">
            <label>Country Field</label>
            <select v-model="instance.country_field" class="form-control">
                <option v-if="instance.program_coid" value="Country">Contact Country</option>
                <option v-for="field in countryfields" v-bind:value="field.id ? field.id + '__' + field.internalName : field.internalName" :key="'cntry-' + field.internalName">
                    {{ field.name }}
                </option>
            </select>
          </div>
        </div>

        <!-- Message (Full Width) -->
        <div class="full-width">
          <div class="form-group">
            <div class="label-with-checkbox">
              <label>
                Message
                <span v-if="lastFocusedField === 'message'" class="merge-focus-indicator">‚Üê Inserting here</span>
              </label>
              <div class="checkbox-wrapper">
                <label>Merge</label>
                <input type="checkbox" v-model="showMerge">
              </div>
            </div>
            
            <!-- Merge Toolbar -->
            <div v-if="showMerge" class="merge-toolbar">
              <div class="merge-toolbar-row">
                <div class="merge-section" style="width: 150px;">
                  <label>Contact Field</label>
                  <select v-model="selectedContactField" @change="insertMerge(selectedContactField)" class="form-control">
                    <option value="">Choose field</option>
                    <option v-for="field in contactFields" v-bind:value="field.value" :key="'cf-' + field.value">{{ field.name }}</option>
                  </select>
                </div>
                
                <div class="merge-section" style="width: 150px;">
                  <label>Custom Object</label>
                  <v-select
                    v-model="selectedMergeCDO"
                    label="name"
                    :options="comerge"
                    @search="fetchOptionsmerge"
                    @input="loadMergeCDOFields"
                    placeholder="Select Object">
                  </v-select>
                </div>
                
                <div class="merge-section" style="width: 150px;" v-if="selectedMergeCDO">
                  <label>CDO Field</label>
                  <select v-model="selectedCDOField" @change="insertMerge(selectedCDOField)" class="form-control">
                    <option value="">Choose field</option>
                    <option v-for="field in cdoMergeFields" v-bind:value="field.value" :key="'cdof-' + field.value">{{ field.name }}</option>
                  </select>
                </div>
                
                <div class="merge-section" style="width: 100px;">
                  <label>If Multiple</label>
                  <select v-model="instance.send_mode" class="form-control">
                    <option value="all">All</option>
                    <option value="first">First</option>
                    <option value="last">Last</option>
                  </select>
                </div>
              </div>
            </div>
            
            <textarea 
              ref="messageTextarea"
              v-model="instance.message" 
              class="form-control" 
              rows="5"
              @focus="handleFocus('message')"
              placeholder="Enter your text message here, you can send up to 4 joined messages of 153 characters each.

Standardised opt out message can be removed if not legally required. Please see your local SPAM compliance rules on use.

Opt-out reply STOP"></textarea>
            <p style="font-size: 11px; color: #666; margin-top: 5px;">
              <i>Characters: {{ messageLength }} | Segments: {{ messageSegments }}</i>
            </p>
          </div>
        </div>

        <!-- Tracked Link (Full Width) -->
        <div class="full-width">
          <div class="form-group">
            <label for="tracked_link">
              Tracked Link URL
              <span v-if="lastFocusedField === 'tracked_link'" class="merge-focus-indicator">‚Üê Inserting here</span>
            </label>
            <input 
              ref="trackedLinkInput"
              type="text" 
              class="form-control" 
              v-model="instance.tracked_link"
              @focus="handleFocus('tracked_link')"
              placeholder="Enter URL to track (will be shortened automatically)"/>
            <p style="font-size: 11px; color: #666; margin-top: 5px;">
                <i>Add [tracked-link] to your message above. The URL you enter here will be automatically shortened and inserted. You can use merge fields like [C_OrderNumber] in this URL.</i>
            </p>
          </div>
        </div>

        <!-- Message Expiry -->
        <div class="full-width">
          <div class="form-group">
            <label>Pending Message Expiry</label>
            <div>
              <select v-model="instance.message_expiry" style="width:100px; display:inline-block; margin-right: 10px;" class="form-control">
                <option value="YES">YES</option>
                <option value="NO">NO</option>
              </select>
              <span style="margin-right: 10px;">If message undeliverable stop trying after</span>
              <select v-model="instance.message_validity" style="width:100px; display:inline-block;" class="form-control">
                <% for(var j=1; j<= 10; j++) { %>
                <option value="<%= j %>"><%= j %> HR</option>
                <% } %>
              </select>
            </div>
          </div>
        </div>

        <!-- Test SMS Section -->
        <div class="test-sms-section">
          <h5>Test Your SMS</h5>
          
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <div style="display: flex; align-items: center; gap: 5px;">
              <select v-model="consumer.default_country" style="width:100px;" class="form-control">
                <option v-for="country in countries" v-bind:value="country.name" :key="country.name">
                  {{ country.alpha2 + country.countryCallingCodes[0] }}
                </option>
              </select>
              <input type="text" v-model="instance.test_phone" style="width:150px;" class="form-control" placeholder="Phone number"/>
              <button @click.prevent="testSMS" type="button" class="btn btn-default" :disabled="testingSms || !instance.message || !instance.test_phone">
                <span v-if="testingSms">
                  <span class="spinner spinner-sm"></span>
                  Sending...
                </span>
                <span v-else>Test SMS</span>
              </button>
            </div>
            <div>
              <button @click.prevent="saveInstance" type="button" class="btn btn-default" :disabled="saving">
                <span v-if="!saving">SAVE</span>
                <span v-if="saving">
                  <span class="spinner spinner-sm"></span>
                  Saving...
                </span>
              </button>
            </div>
          </div>

          <!-- Test SMS Status -->
          <div v-if="messageStatus.success" class="test-status success">
            <strong>‚úì Success!</strong>
            <span>{{ messageStatus.success }}</span>
            <div v-if="messageStatus.details" class="test-status-details">
              <div><strong>Message ID:</strong> {{ messageStatus.details.messageId }}</div>
              <div><strong>Sent to:</strong> {{ messageStatus.details.to }}</div>
              <div><strong>Length:</strong> {{ messageStatus.details.messageLength }} characters</div>
              <div v-if="messageStatus.details.cost"><strong>Cost:</strong> ${{ messageStatus.details.cost }}</div>
              <div v-if="messageStatus.details.hasTrackedLink"><strong>Tracked Link:</strong> Yes</div>
            </div>
          </div>
          
          <div v-if="messageStatus.error" class="test-status error">
            <strong>‚úó Error</strong>
            <span>{{ messageStatus.error }}</span>
            <div v-if="messageStatus.description" style="margin-top: 5px; font-size: 12px;">
              {{ messageStatus.description }}
            </div>
          </div>
        </div>

        <!-- Custom Object Mapping Display (READ-ONLY) -->
        <div class="cdo-mapping-box">
          <h5>üìã Custom Object Mapping</h5>
          
          <div v-if="hasCdoConfig">
            <div class="cdo-name">
              ‚úì Custom Object: {{ cdoName || 'Loading...' }}
            </div>
            
            <div class="cdo-field-row" v-if="cdoConfig.mobile_field">
              <span class="cdo-field-label">Mobile Number:</span>
              <span class="cdo-field-value">{{ cdoConfig.mobile_field }}</span>
            </div>
            
            <div class="cdo-field-row" v-if="cdoConfig.email_field">
              <span class="cdo-field-label">Email Address:</span>
              <span class="cdo-field-value">{{ cdoConfig.email_field }}</span>
            </div>
            
            <div class="cdo-field-row" v-if="cdoConfig.outgoing_field">
              <span class="cdo-field-label">Outgoing Message:</span>
              <span class="cdo-field-value">{{ cdoConfig.outgoing_field }}</span>
            </div>
            
            <div class="cdo-field-row" v-if="cdoConfig.notification_field">
              <span class="cdo-field-label">Notification Status:</span>
              <span class="cdo-field-value">{{ cdoConfig.notification_field }}</span>
            </div>
            
            <div class="cdo-field-row" v-if="cdoConfig.title_field">
              <span class="cdo-field-label">Campaign Title:</span>
              <span class="cdo-field-value">{{ cdoConfig.title_field }}</span>
            </div>
            
            <div class="cdo-field-row" v-if="cdoConfig.vn_field">
              <span class="cdo-field-label">Virtual Number:</span>
              <span class="cdo-field-value">{{ cdoConfig.vn_field }}</span>
            </div>

            <div style="margin-top: 15px; padding-top: 10px; border-top: 1px solid #dee2e6; font-size: 12px; color: #666;">
              <strong>Note:</strong> SMS send data will be automatically logged to this custom object.
              To change these mappings, go to <strong>Application Settings</strong>.
            </div>
          </div>

          <div v-else>
            <div class="cdo-no-config">
              No custom object configured
            </div>
            <div style="text-align: center; margin-top: 10px; font-size: 12px; color: #666;">
              SMS sends will be tracked internally but not logged to a custom object.
              To enable custom object logging, configure it in <strong>Application Settings</strong>.
            </div>
          </div>
        </div>
        
        <!-- ‚úÖ UPDATED: SMS Summary Chart with 5 cards -->
        <div class="report-section">
          <h5>üìä SMS Send Summary</h5>

          <!-- Loading State -->
          <div v-if="loadingReport" class="loading-spinner">
            <div class="spinner"></div>
            <p>Loading statistics...</p>
          </div>

          <!-- ‚úÖ UPDATED: Statistics Cards - Now 5 cards -->
          <div v-else class="report-stats">
            <div class="stat-card sent">
              <span class="stat-number">{{ reportStats.sent.count }}</span>
              <span class="stat-label">Sent</span>
              <span class="stat-label" style="font-size: 10px; color: #999;">${{ reportStats.sent.cost.toFixed(2) }}</span>
            </div>
            <div class="stat-card delivered">
              <span class="stat-number">{{ reportStats.delivered.count }}</span>
              <span class="stat-label">Delivered</span>
              <span class="stat-label" style="font-size: 10px; color: #999;">${{ reportStats.delivered.cost.toFixed(2) }}</span>
            </div>
            <!-- ‚úÖ NEW: Bounced Card -->
            <div class="stat-card bounced">
              <span class="stat-number">{{ reportStats.bounced.count }}</span>
              <span class="stat-label">Bounced</span>
              <span class="stat-label" style="font-size: 10px; color: #999;">${{ reportStats.bounced.cost.toFixed(2) }}</span>
            </div>
            <div class="stat-card failed">
              <span class="stat-number">{{ reportStats.failed.count }}</span>
              <span class="stat-label">Failed</span>
              <span class="stat-label" style="font-size: 10px; color: #999;">${{ reportStats.failed.cost.toFixed(2) }}</span>
            </div>
            <div class="stat-card pending">
              <span class="stat-number">{{ reportStats.pending.count }}</span>
              <span class="stat-label">Pending</span>
            </div>
          </div>

          <!-- Refresh and View Full Report -->
          <div class="report-actions">
            <button type="button" @click="loadReport" class="btn btn-default" :disabled="loadingReport" style="width: auto; padding: 8px 20px; font-size: 13px; margin-right: 10px;">
              <span v-if="loadingReport">
                <span class="spinner spinner-sm"></span>
                Refreshing...
              </span>
              <span v-else>üîÑ Refresh</span>
            </button>
            <button type="button" @click="openReport" class="btn btn-report" style="padding: 8px 20px; font-size: 13px;">
              View Full Report
            </button>
          </div>
        </div>

        <!-- Bottom Status (for SAVE action) -->
        <div v-if="status.success || status.error" 
             v-bind:class="{ 'alert-success': status.success, 'alert-danger': status.error, 'fade-out': statusFading }" 
             class="alert" 
             role="alert">
          <button type="button" class="close" @click="clearStatus">&times;</button>
          <strong>{{ status.success ? '‚úì' : '‚úó' }}</strong> {{ status.success || status.error }}
        </div>
      </form>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.11"></script>
    <script src="/eloqua-service/assets/js/axios.min.js"></script>
    <script src="https://unpkg.com/vue-select@3.0.0"></script>

    <script type="text/javascript">
      var instance = <%-JSON.stringify(instance)%>;
      var custom_objects = <%-JSON.stringify(custom_objects)%>;
      var merge_fields_initial = <%-JSON.stringify(merge_fields)%>;
      var sender_ids_initial = <%-JSON.stringify(sender_ids)%>;
      var consumer = <%-JSON.stringify(consumer)%>;

      if(!instance.send_mode){
        instance.send_mode = "all";
      }

      Vue.component('v-select', VueSelect.VueSelect);
      
      var comerge = JSON.parse(JSON.stringify(custom_objects.elements || []));

      // Build contact fields for merge
      var contactFieldsArray = [
        {name: 'Choose field', value: ''},
        {name: 'Tracked Link', value: '[tracked-link]'},
        {name: 'Unsub Reply Link', value: '[unsub-reply-link]'}
      ];
      
      if (Array.isArray(merge_fields_initial)) {
        merge_fields_initial.forEach(function(field){
          if (field && field.name && field.internalName) {
            contactFieldsArray.push({
              name: field.name, 
              value: '[' + field.internalName + ']'
            });
          }
        });
      }

      var app = new Vue({
        el: '#sendsmsaction',
        data: {
          instance: instance,
          consumer: consumer,
          status: {},
          statusFading: false,
          countries: <%-JSON.stringify(countries)%>,
          custom_objects: custom_objects,
          comerge: comerge,
          fields: merge_fields_initial || [],
          countryfields: merge_fields_initial || [],
          fade: false,
          saving: false,
          loadingSenderIds: false,
          sender_ids: sender_ids_initial || {'Virtual Number': [], 'Business Name': [], 'Mobile Number': []},
          
          showMerge: false,
          contactFields: contactFieldsArray,
          selectedContactField: '',
          selectedMergeCDO: null,
          selectedCDOField: '',
          cdoMergeFields: [],
          
          lastFocusedField: 'message',
          
          // CDO info display
          cdoName: null,
          cdoConfig: {
            mobile_field: null,
            email_field: null,
            outgoing_field: null,
            notification_field: null,
            title_field: null,
            vn_field: null
          },
          
          // Test SMS
          messageStatus: {},
          testingSms: false,
          
          // ‚úÖ UPDATED: Report summary data with bounced
          reportStats: {
            sent: { count: 0, cost: 0 },
            delivered: { count: 0, cost: 0 },
            bounced: { count: 0, cost: 0 },  // ‚úÖ NEW
            failed: { count: 0, cost: 0 },
            pending: { count: 0, cost: 0 }
          },
          loadingReport: false
        },
        computed: {
          messageLength: function() {
            return (this.instance.message || '').length;
          },
          messageSegments: function() {
            var len = this.messageLength;
            if (len === 0) return 0;
            if (len <= 160) return 1;
            return Math.ceil(len / 153);
          },
          hasCdoConfig: function() {
            return !!(this.consumer.actions && 
                     this.consumer.actions.sendsms && 
                     this.consumer.actions.sendsms.custom_object_id);
          }
        },
        methods: {
          openReport: function() {
            var url = '/eloqua/action/report/' + this.instance.instanceId + '?installId=' + this.consumer.installId + '&siteId=' + this.consumer.SiteId;
            window.open(url, 'ActionReport', 'width=1400,height=900,scrollbars=yes,resizable=yes');
          },

          loadReport: function() {
            var vm = this;
            vm.loadingReport = true;

            axios.get('/eloqua/action/report/' + this.instance.instanceId + '/data', {
              params: {
                page: 1,
                limit: 1,
                status: 'all',
                installId: this.consumer.installId,
                siteId: this.consumer.SiteId
              }
            })
            .then(function(response) {
              vm.reportStats = response.data.stats;
              vm.loadingReport = false;
            })
            .catch(function(error) {
              console.error('Error loading report:', error);
              vm.loadingReport = false;
            });
          },

          handleFocus: function(fieldName) {
            this.lastFocusedField = fieldName;
            console.log('Focused on:', fieldName);
          },

          clearStatus: function() {
            var vm = this;
            vm.statusFading = true;
            setTimeout(function() {
              vm.status = {};
              vm.fade = false;
              vm.statusFading = false;
            }, 300);
            vm.messageStatus = {};
          },
          
          insertMerge: function(value) {
            if (!value) return;
            
            var vm = this;
            var targetElement = null;
            
            console.log('Inserting merge field:', value, 'into:', this.lastFocusedField);
            
            if (this.lastFocusedField === 'tracked_link') {
              targetElement = this.$refs.trackedLinkInput;
              
              if (targetElement) {
                var startPos = targetElement.selectionStart || 0;
                var endPos = targetElement.selectionEnd || 0;
                var currentText = this.instance.tracked_link || '';
                
                this.instance.tracked_link = currentText.substring(0, startPos) + value + currentText.substring(endPos);
                
                this.$nextTick(function() {
                  targetElement.focus();
                  var newPos = startPos + value.length;
                  targetElement.setSelectionRange(newPos, newPos);
                });
                
                console.log('‚úì Inserted into tracked link:', value);
              }
            } else {
              targetElement = this.$refs.messageTextarea;
              
              if (targetElement) {
                var startPos = targetElement.selectionStart || 0;
                var endPos = targetElement.selectionEnd || 0;
                var currentText = this.instance.message || '';
                
                this.instance.message = currentText.substring(0, startPos) + value + currentText.substring(endPos);
                
                this.$nextTick(function() {
                  targetElement.focus();
                  var newPos = startPos + value.length;
                  targetElement.setSelectionRange(newPos, newPos);
                });
                
                console.log('‚úì Inserted into message:', value);
              }
            }
            
            this.selectedContactField = '';
            this.selectedCDOField = '';
          },
          
          loadMergeCDOFields: function(cdo) {
            if (!cdo) {
              this.cdoMergeFields = [];
              return;
            }
            
            var vm = this;
            
            axios.get('/eloqua/action/ajax/customobject/' + this.consumer.installId + '/' + this.consumer.SiteId + '/' + cdo.id)
              .then(function(response) {
                vm.cdoMergeFields = [];
                
                if (response.data.fields && Array.isArray(response.data.fields)) {
                  response.data.fields.forEach(function(field) {
                    if (field && field.name && field.id) {
                      vm.cdoMergeFields.push({
                        name: field.name,
                        value: '{{CustomObject<' + cdo.id + '>.Field<' + field.id + '>}}'
                      });
                    }
                  });
                }
              })
              .catch(function(error) {
                console.error('Error loading CDO fields:', error);
                vm.cdoMergeFields = [];
              });
          },
          
          fetchOptionsmerge: function(search, loading) {
            var vm = this;
            
            axios.get('/eloqua/action/ajax/customobjects/' + this.consumer.installId + '/' + this.consumer.SiteId + '/customObject?search=' + encodeURIComponent(search || ''))
              .then(function(response) {
                vm.comerge = response.data.elements || [];
              })
              .catch(function(error) {
                vm.comerge = JSON.parse(JSON.stringify(custom_objects.elements || []));
              });
          },
          
          loadCdoInfo: function() {
            var vm = this;
            
            if (!this.hasCdoConfig) {
              return;
            }
            
            var cdoId = this.consumer.actions.sendsms.custom_object_id;
            
            this.cdoConfig = {
              mobile_field: this.consumer.actions.sendsms.mobile_field || null,
              email_field: this.consumer.actions.sendsms.email_field || null,
              outgoing_field: this.consumer.actions.sendsms.outgoing_field || null,
              notification_field: this.consumer.actions.sendsms.notification_field || null,
              title_field: this.consumer.actions.sendsms.title_field || null,
              vn_field: this.consumer.actions.sendsms.vn_field || null
            };
            
            axios.get('/eloqua/action/ajax/customobject/' + this.consumer.installId + '/' + this.consumer.SiteId + '/' + cdoId)
              .then(function(response) {
                vm.cdoName = response.data.name || 'Custom Object';
              })
              .catch(function(error) {
                console.error('Error loading CDO info:', error);
                vm.cdoName = 'Custom Object (ID: ' + cdoId + ')';
              });
          },
          
          getProgramFields: function(){
            var vm = this;
            if(this.instance.program_coid){
              axios.get('/eloqua/action/ajax/customobject/' + this.consumer.installId + '/' + this.consumer.SiteId + '/' + this.instance.program_coid)
                .then(function(response){
                  if(vm.instance.country_setting == "cf"){
                    vm.countryfields = response.data.fields;
                  }
                  else{
                    vm.countryfields = merge_fields_initial;
                  }
                  vm.fields = response.data.fields;
                })
                .catch(function (error) {
                  console.error("Error:", error);
                });
            }
            else{
              vm.countryfields = vm.fields;
            }
          },
          
          testSMS: function(){
            var vm = this;
            var testmessage = vm.instance.message || '';
            
            vm.messageStatus = {};
            
            if (!testmessage.trim()) {
              vm.messageStatus = {
                error: 'Message is required',
                description: 'Please enter a message before sending test SMS'
              };
              return;
            }
            
            if (!vm.instance.test_phone || !vm.instance.test_phone.trim()) {
              vm.messageStatus = {
                error: 'Phone number is required',
                description: 'Please enter a phone number'
              };
              return;
            }
            
            vm.testingSms = true;
            
            var templated_fields = testmessage.match(/\[C_[^\]]+\]/g);
            if (templated_fields) {
              templated_fields.forEach(function (field) {
                if(field.indexOf('tracked-link') == -1 && field.indexOf('unsub-reply-link') == -1){
                  var fieldName = field.replace('[C_', '').replace(']', '');
                  var nfield = field.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&');
                  var msgrgex = new RegExp(nfield, "g");
                  testmessage = testmessage.replace(msgrgex, fieldName);
                }
              });
            }
            
            var data = {
              "message": testmessage,
              "caller_id": vm.instance.caller_id || ''
            };
            
            if(vm.instance.tracked_link && vm.instance.tracked_link.trim()){
              data.tracked_link_url = vm.instance.tracked_link.trim();
            }
            
            axios.post('/eloqua/action/ajax/testsms/' + vm.consumer.installId + '/' + vm.consumer.SiteId + '/' + vm.consumer.default_country + '/' + encodeURIComponent(vm.instance.test_phone), data)
              .then(function(response){
                vm.messageStatus = {
                  success: 'Test SMS sent successfully!',
                  details: {
                    messageId: response.data.messageId,
                    to: response.data.to,
                    messageLength: response.data.messageLength,
                    cost: response.data.cost,
                    hasTrackedLink: response.data.hasTrackedLink
                  }
                };
                vm.testingSms = false;
              })
              .catch(function (error) {
                vm.messageStatus = {
                  error: error.response?.data?.error || 'Failed to send test SMS',
                  description: error.response?.data?.description || error.message
                };
                vm.testingSms = false;
              });
          },
          
          saveInstance: function(){
            var vm = this;

            delete vm.instance.custom_object_id;
            delete vm.instance.email_field;
            delete vm.instance.mobile_field;
            delete vm.instance.title_field;
            delete vm.instance.notification_field;
            delete vm.instance.outgoing_field;
            delete vm.instance.vn_field;

            if(vm.instance.message){
              vm.saving = true;
              vm.messageStatus = {};
              
              axios.post(location.pathname + location.search, {"instance": vm.instance})
                .then(function(response){
                  vm.messageStatus = { success: 'Configuration successfully updated' };
                  vm.saving = false;
                  vm.loadReport();
                })
                .catch(function (error) {
                  vm.messageStatus = { 
                    error: error.response?.data?.message || 'Failed to update instance!',
                    description: error.response?.data?.description || ''
                  };
                  vm.saving = false;
                });
            }
            else{
              vm.messageStatus = { 
                error: 'Message is required',
                description: 'Please enter a message before saving'
              };
            }
          }
        },
        mounted: function () {
          this.fields = this.fields.map(function(field) {
            if (!field.internalName) {
              field.internalName = field.name ? field.name.replace(/\s+/g, '') : 'UnknownField';
            }
            return field;
          });
          
          this.getProgramFields();
          this.loadCdoInfo();
          this.loadReport();
        }
      });
    </script>
  </body>
</html>