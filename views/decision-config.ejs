<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>TransmitSMS: Configure Decision Service</title>

    <link href="/eloqua-service/assets/css/bootstrap.min.css" rel="stylesheet">
    <link href="/eloqua-service/assets/css/main.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/vue-select@3.0.0/dist/vue-select.css">
  </head>
  <body>
    <div class="disabler"></div>
    <div id="receivesmsaction" class="container" style="width: 900px; text-align: center; padding-top: 40px">
      <img src="/eloqua-service/assets/images/received-sms-el-icon.png" alt="Check for Received SMS">
      <br/><br/>
      
      <div v-if="status.success || status.error" v-bind:class="{ 'alert-success': status.success, 'alert-danger': status.error, 'in': fade }" class="alert alert-dismissible fade" role="alert">
        {{ status.success || status.error }}
      </div>

      <div class="container" style="width: 47%; float: left; text-align: left; margin-left: 25px; border-right: 2px solid #ccc; height: 550px;">
        <h4 style="font-size: 20px; font-weight: bold; text-align: left;">
          Decision Settings
        </h4>
        <br/>

        <div class="form-group">
          <label for="evaluation_period" style="width: 320px; text-align: left;">How long should we wait for a reply?</label>
          <select style="width: 320px; text-align: left;" v-model="instance.evaluation_period" class="form-control">
            <option v-for="hour in evaluation" v-bind:value="hour">{{ hour }} HR</option>
          </select>
          <p style="width: 320px; text-align: left; font-size: 11px;">
            <i>The system will wait this many hours for a reply before deciding "No Response".</i>
          </p>
        </div>

        <div class="form-group">
          <label for="text_type" style="width: 320px; text-align: left;">What type of text are we looking for?</label>
          <select v-model="instance.text_type" style="width: 320px; text-align: left;" class="form-control">
            <option v-for="type in texttype" v-bind:value="type">{{ type }}</option>
          </select>
          <p style="width: 320px; text-align: left; font-size: 11px;">
            <i>Choose "Anything" to accept any reply, or "Keyword" to match specific words.</i>
          </p>
        </div>

        <div class="form-group" v-show="instance.text_type == 'Keyword'">
          <label for="keyword" style="width: 320px; text-align: left;">Keyword(s)</label>
          <input type="text" v-model="instance.keyword" style="width: 320px; text-align: left;" class="form-control" placeholder="Enter keywords separated by commas"/>
          <p style="width: 320px; text-align: left; font-size: 11px;">
            <i>Example: YES, CONFIRM, OK (comma-separated, case-insensitive)</i>
          </p>
        </div>

        <div class="form-group">
          <label for="custom_object_id" style="width: 320px; text-align: left;">Custom Object Mapping (Optional)</label>
          <v-select  
            label="name"
            style="width: 320px; height: 34px;"
            v-model="instance.custom_object_id" 
            :reduce="element => element.id" 
            :options="comap" 
            @search="fetchOptionsmap" 
            @input="getFields()"
            placeholder="Select custom object...">
          </v-select>
          <p style="width: 320px; text-align: left; font-size: 11px;">
            <i>Optionally log reply data to a custom object.</i>
          </p>
        </div>

      </div>

      <div class="container" style="width: 47%; float: right; text-align: left; padding-left: 40px;">
        <h4 style="font-size: 20px; font-weight: bold; text-align: left;">
          Custom Object Field Mapping
        </h4>
        <br/>

        <div v-show="!instance.custom_object_id" style="padding: 20px; background-color: #f9f9f9; border-radius: 4px; margin-bottom: 20px;">
          <p style="color: #666; margin: 0;">
            <i class="glyphicon glyphicon-info-sign"></i>
            Select a Custom Object from the left panel to configure field mappings.
          </p>
        </div>

        <div v-show="instance.custom_object_id">
          <div class="form-group">
            <label for="mobile_field" style="width: 320px; text-align: left;">Map Contact Mobile To</label>
            <select v-model="instance.mobile_field" style="width: 320px; text-align: left;" class="form-control">
              <option value="">-- Select Field --</option>
              <option v-for="field in cdofields" v-bind:value="field.internalName">
                {{ field.name }}
              </option>
            </select>
          </div>

          <div class="form-group">
            <label for="email_field" style="width: 320px; text-align: left;">Map Contact Email To</label>
            <select v-model="instance.email_field" style="width: 320px; text-align: left;" class="form-control">
              <option value="">-- Select Field --</option>
              <option v-for="field in cdofields" v-bind:value="field.internalName">
                {{ field.name }}
              </option>
            </select>
          </div>

          <div class="form-group">
            <label for="response_field" style="width: 320px; text-align: left;">Map Reply Message To</label>
            <select v-model="instance.response_field" style="width: 320px; text-align: left;" class="form-control">
              <option value="">-- Select Field --</option>
              <option v-for="field in cdofields" v-bind:value="field.internalName">
                {{ field.name }}
              </option>
            </select>
          </div>

          <div class="form-group">
            <label for="title_field" style="width: 320px; text-align: left;">Map Campaign Title To</label>
            <select v-model="instance.title_field" style="width: 320px; text-align: left;" class="form-control">
              <option value="">-- Select Field --</option>
              <option v-for="field in cdofields" v-bind:value="field.internalName">
                {{ field.name }}
              </option>
            </select>
          </div>

          <div class="form-group">
            <label for="vn_field" style="width: 320px; text-align: left;">Map Virtual Number To</label>
            <select v-model="instance.vn_field" style="width: 320px; text-align: left;" class="form-control">
              <option value="">-- Select Field --</option>
              <option v-for="field in cdofields" v-bind:value="field.internalName">
                {{ field.name }}
              </option>
            </select>
          </div>
        </div>

        <div style="margin-top: 40px; padding: 15px; background-color: #e7f3ff; border-left: 4px solid #2196F3; border-radius: 4px;">
          <strong>How it works:</strong>
          <ul style="margin: 10px 0 0 0; padding-left: 20px; font-size: 12px;">
            <li>Place this decision node after your Send SMS action</li>
            <li>The system will wait for replies from recipients</li>
            <li>If a matching reply is received, the contact follows the "YES" path</li>
            <li>If no reply or timeout occurs, the contact follows the "NO" path</li>
          </ul>
        </div>

      </div>

      <br/>

      <div class="container" style="width: 100%; margin-top: 570px; clear: both;">
        <button id="btnSave" type="button" v-on:click="saveInstance()" class="btn btn-default">SAVE CONFIGURATION</button>
      </div>

      <div v-if="status.success || status.error" v-bind:class="{ 'alert-success': status.success, 'alert-danger': status.error, 'in': fade }" class="alert alert-dismissible fade" role="alert">
        {{ status.success || status.error }}
      </div>

    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.11"></script>
    <script src="/eloqua-service/assets/js/axios.min.js"></script>
    <script src="https://unpkg.com/vue-select@3.0.0"></script>

    <script type="text/javascript">
      var instance = <%-JSON.stringify(instance)%>;
      Vue.component('v-select', VueSelect.VueSelect);
      var custom_objects = <%-JSON.stringify(custom_objects)%>;
      var comap = JSON.parse(JSON.stringify(custom_objects.elements));

      var app = new Vue({
        el: '#receivesmsaction',
        data: {
          evaluation: Array.from({length: 168}, (_, i) => i + 1),
          texttype: ["Anything", "Keyword"],
          instance: instance,
          consumer: <%-JSON.stringify(consumer)%>,
          status: {},
          custom_objects: custom_objects,
          comap: comap,
          cdofields: [],
          fade: false
        },
        methods: {
          fetchOptionsmap: function(search, loading) {
            var vm = this;
            const options = {
              method: "GET",
              url: "/eloqua/decision/ajax/customobjects/" + this.consumer.installId + "/" + this.consumer.SiteId + "/customObject?search=" + search
            };
            axios(options)
              .then(function(response) {
                console.log("Custom objects fetched", response);
                vm.comap = response.data.elements;
              })
              .catch(function (error) {
                console.error("Failed to fetch custom objects", error);
                vm.comap = JSON.parse(JSON.stringify(custom_objects.elements)); 
              });
          },
          getFields() {
            var vm = this;
            if(this.instance.custom_object_id) {
              const options = {
                method: "GET",
                url: "/eloqua/decision/ajax/customobject/" + this.consumer.installId + "/" + this.consumer.SiteId + "/" + this.instance.custom_object_id
              };
              axios(options)
                .then(function(response) {
                  console.log("Custom object fields fetched", response);
                  vm.cdofields = response.data.fields;
                })
                .catch(function (error) {
                  console.error("Failed to fetch fields", error);
                });
            }
          },
          saveInstance() {
            var vm = this;

            // Clear field mappings if no custom object selected
            if(!this.instance.custom_object_id) {
              this.instance.email_field = null;
              this.instance.mobile_field = null;
              this.instance.title_field = null;
              this.instance.response_field = null;
              this.instance.vn_field = null;
            }

            // Validation
            if(!this.instance.evaluation_period) {
              vm.status = { error: 'Evaluation period is required' };
              vm.fade = true;
              setTimeout(() => {
                vm.fade = false;
                vm.status = {};
              }, 3000);
              return;
            }

            if(this.instance.text_type === 'Keyword' && !this.instance.keyword) {
              vm.status = { error: 'Keyword is required when text type is "Keyword"' };
              vm.fade = true;
              setTimeout(() => {
                vm.fade = false;
                vm.status = {};
              }, 3000);
              return;
            }

            const options = {
              method: "POST",
              url: location.pathname + location.search,
              headers: { 'Content-Type': 'application/json' },
              data: JSON.stringify({"instance": vm.instance})
            };

            axios(options)
              .then(function(response) {
                vm.fade = true;
                console.log("Configuration saved", response);
                vm.status = { success: 'Configuration successfully saved' };
                setTimeout(() => {
                  vm.fade = false;
                  vm.status = {};
                }, 3000);
              })
              .catch(function (error) {
                vm.fade = true;
                console.error("Failed to save configuration", error);
                vm.status = { 
                  error: 'Failed to save configuration: ' + (error.response?.data?.error || error.message) 
                };
                setTimeout(() => {
                  vm.fade = false;
                  vm.status = {};
                }, 3000);
              });
          }
        },
        mounted: function () {
          console.log("Vue app mounted", {
            instance: this.instance,
            consumer: this.consumer,
            custom_objects: this.custom_objects
          });
          this.getFields();
        }
      });
    </script>
  </body>
</html>