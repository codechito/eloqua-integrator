<!-- views/decision-config.ejs -->
<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Configure Decision Service</title>

    <link href="/eloqua-service/assets/css/bootstrap.min.css" rel="stylesheet">
    <link href="/eloqua-service/assets/css/main.css" rel="stylesheet">
    <style type="text/css">
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }

      .spinner {
        border: 3px solid #f3f3f3;
        border-top: 3px solid #4CAF50;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        animation: spin 1s linear infinite;
        display: inline-block;
        margin-right: 10px;
      }

      .spinner-sm {
        width: 16px;
        height: 16px;
        border-width: 2px;
        margin-right: 5px;
        vertical-align: middle;
      }

      body {
        font-family: Arial, sans-serif;
        padding: 0;
        margin: 0;
      }
      .container {
        max-width: 700px;
        margin: 40px auto;
        padding: 30px;
        background: #fff;
      }
      h4 {
        font-size: 20px;
        font-weight: bold;
        text-align: center;
        margin-bottom: 30px;
      }
      h4 img {
        vertical-align: middle;
        margin-right: 10px;
      }
      .form-group {
        margin-bottom: 20px;
      }
      .form-group label {
        display: block;
        font-weight: bold;
        margin-bottom: 8px;
        font-size: 14px;
      }
      .form-control {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
        box-sizing: border-box;
      }
      .form-control:focus {
        outline: none;
        border-color: #007bff;
      }
      .help-text {
        font-size: 12px;
        color: #666;
        margin-top: 5px;
        line-height: 1.4;
      }
      .btn {
        padding: 12px 30px;
        background: #007bff;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        font-weight: bold;
        width: 100%;
        margin-top: 10px;
      }
      .btn:hover {
        background: #0056b3;
      }
      .btn:disabled {
        background: #ccc;
        cursor: not-allowed;
      }
      .alert {
        padding: 12px 15px;
        border-radius: 4px;
        margin-bottom: 20px;
        font-size: 14px;
      }
      .alert-success {
        background: #d4edda;
        border: 1px solid #c3e6cb;
        color: #155724;
      }
      .alert-danger {
        background: #f8d7da;
        border: 1px solid #f5c6cb;
        color: #721c24;
      }
      .alert.fade {
        opacity: 0;
        transition: opacity 0.5s ease-in-out;
      }
      .alert.fade.in {
        opacity: 1;
      }
      .cdo-mapping-box {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        padding: 15px;
        margin-bottom: 20px;
      }
      .cdo-mapping-box h5 {
        margin: 0 0 15px 0;
        font-size: 15px;
        font-weight: bold;
        color: #495057;
        border-bottom: 2px solid #dee2e6;
        padding-bottom: 8px;
      }
      .cdo-field-row {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px solid #e9ecef;
        font-size: 13px;
      }
      .cdo-field-row:last-child {
        border-bottom: none;
      }
      .cdo-field-label {
        font-weight: 600;
        color: #6c757d;
        flex: 0 0 40%;
      }
      .cdo-field-value {
        color: #212529;
        flex: 1;
        text-align: right;
        font-family: 'Courier New', monospace;
      }
      .cdo-no-config {
        text-align: center;
        color: #6c757d;
        font-style: italic;
        padding: 10px;
      }
      .cdo-name {
        background: #007bff;
        color: white;
        padding: 8px 12px;
        border-radius: 4px;
        margin-bottom: 15px;
        font-size: 13px;
        font-weight: bold;
      }
      .section-divider {
        border-top: 2px solid #dee2e6;
        margin: 30px 0;
      }

      .report-section {
        background: #fff;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        padding: 15px;
        margin-bottom: 15px;
      }

      .report-section h5 {
        margin: 0 0 15px 0;
        font-size: 15px;
        font-weight: bold;
        color: #495057;
        border-bottom: 2px solid #dee2e6;
        padding-bottom: 8px;
      }

      .report-stats {
        display: flex;
        justify-content: space-around;
        margin-bottom: 20px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 4px;
      }

      .stat-card {
        text-align: center;
        flex: 1;
      }

      .stat-card .stat-number {
        font-size: 32px;
        font-weight: bold;
        color: #007bff;
        display: block;
      }

      .stat-card .stat-label {
        font-size: 12px;
        color: #6c757d;
        text-transform: uppercase;
        margin-top: 5px;
      }

      .stat-card.success .stat-number {
        color: #28a745;
      }

      .stat-card.danger .stat-number {
        color: #dc3545;
      }

      .stat-card.warning .stat-number {
        color: #ffc107;
      }

      .report-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 13px;
      }

      .report-table thead {
        background: #f8f9fa;
      }

      .report-table th {
        padding: 10px;
        text-align: left;
        font-weight: bold;
        color: #495057;
        border-bottom: 2px solid #dee2e6;
      }

      .report-table td {
        padding: 8px 10px;
        border-bottom: 1px solid #e9ecef;
      }

      .report-table tbody tr:hover {
        background: #f8f9fa;
      }

      .decision-badge {
        display: inline-block;
        padding: 3px 8px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: bold;
        text-transform: uppercase;
      }

      .decision-badge.yes {
        background: #d4edda;
        color: #155724;
      }

      .decision-badge.no {
        background: #f8d7da;
        color: #721c24;
      }

      .decision-badge.pending {
        background: #fff3cd;
        color: #856404;
      }

      .report-filters {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
        align-items: center;
      }

      .report-filters select {
        padding: 5px 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 13px;
        height: auto;
      }

      .report-filters button {
        padding: 5px 15px;
        font-size: 13px;
        width: auto;
      }

      .loading-spinner {
        text-align: center;
        padding: 40px;
        color: #6c757d;
      }

      .no-data {
        text-align: center;
        padding: 40px;
        color: #6c757d;
        font-style: italic;
      }

      .pagination {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 10px;
        margin-top: 15px;
      }

      .pagination button {
        padding: 5px 10px;
        font-size: 12px;
        width: auto;
      }

      .pagination span {
        font-size: 13px;
        color: #6c757d;
      }
    </style>
  </head>
  <body>
    <div class="container" id="receivesmsaction">
      <form method="post">
        <h4>
          <img src="/eloqua-service/assets/images/received-sms-el-icon.png" width="24" height="24">
          Check for Received SMS
        </h4>

        <div v-if="status.success || status.error" 
             v-bind:class="{ 'alert-success': status.success, 'alert-danger': status.error, 'in': fade }" 
             class="alert fade" 
             role="alert">
          {{ status.success || status.error }}
        </div>

        <!-- Decision Configuration -->
        <div class="form-group">
          <label for="evaluation_period">Evaluation Period (hours)</label>
          <select v-model="instance.evaluation_period" class="form-control" id="evaluation_period" required>
            <option v-for="hour in evaluation" v-bind:value="hour" :key="hour">{{ hour }} hour{{ hour > 1 ? 's' : '' }}</option>
          </select>
          <div class="help-text">
            How long to wait for a response after SMS is sent (1-168 hours)
          </div>
        </div>

        <div class="form-group">
          <label for="text_type">Response Type</label>
          <select v-model="instance.text_type" class="form-control" id="text_type" required>
            <option value="Anything">Any Response</option>
            <option value="Keyword">Specific Keyword(s)</option>
          </select>
          <div class="help-text">
            Choose whether any response counts as "YES" or only specific keywords
          </div>
        </div>

        <div class="form-group" v-show="instance.text_type === 'Keyword'">
          <label for="keyword">Keywords (comma-separated)</label>
          <input 
            type="text" 
            v-model="instance.keyword" 
            class="form-control" 
            id="keyword"
            placeholder="e.g., YES, CONFIRM, OK, INTERESTED"
            v-bind:required="instance.text_type === 'Keyword'">
          <div class="help-text">
            Enter keywords to match (case-insensitive). Separate multiple keywords with commas.
          </div>
        </div>

        <div class="section-divider"></div>

        <!-- Custom Object Mapping Display -->
        <div class="cdo-mapping-box">
          <h5>ðŸ“‹ Custom Object Mapping</h5>
          
          <div v-if="hasCdoConfig">
            <div class="cdo-name">
              âœ“ Custom Object: {{ cdoConfig.name || 'Loading...' }}
            </div>
            
            <div class="cdo-field-row" v-if="cdoConfig.mobile_field">
              <span class="cdo-field-label">Mobile Number:</span>
              <span class="cdo-field-value">{{ cdoConfig.mobile_field }}</span>
            </div>
            
            <div class="cdo-field-row" v-if="cdoConfig.email_field">
              <span class="cdo-field-label">Email Address:</span>
              <span class="cdo-field-value">{{ cdoConfig.email_field }}</span>
            </div>
            
            <div class="cdo-field-row" v-if="cdoConfig.response_field">
              <span class="cdo-field-label">Reply Message:</span>
              <span class="cdo-field-value">{{ cdoConfig.response_field }}</span>
            </div>
            
            <div class="cdo-field-row" v-if="cdoConfig.title_field">
              <span class="cdo-field-label">Campaign Title:</span>
              <span class="cdo-field-value">{{ cdoConfig.title_field }}</span>
            </div>
            
            <div class="cdo-field-row" v-if="cdoConfig.vn_field">
              <span class="cdo-field-label">Virtual Number:</span>
              <span class="cdo-field-value">{{ cdoConfig.vn_field }}</span>
            </div>

            <div class="help-text" style="margin-top: 15px; padding-top: 10px; border-top: 1px solid #dee2e6;">
              <strong>Note:</strong> Reply data will be automatically logged to this custom object.
              To change these mappings, go to <strong>Application Settings</strong>.
            </div>
          </div>

          <div v-else>
            <div class="cdo-no-config">
              No custom object configured
            </div>
            <div class="help-text" style="text-align: center; margin-top: 10px;">
              Replies will be tracked internally but not logged to a custom object.
              To enable custom object logging, configure it in <strong>Application Settings</strong>.
            </div>
          </div>
        </div>

        <div class="section-divider"></div>

        <!-- Decision Report Section -->
        <div class="report-section">
          <h5>ðŸ“Š Decision Evaluation Report</h5>

          <!-- Statistics -->
          <div class="report-stats">
            <div class="stat-card success">
              <span class="stat-number">{{ reportStats.yes }}</span>
              <span class="stat-label">YES (Responded)</span>
            </div>
            <div class="stat-card danger">
              <span class="stat-number">{{ reportStats.no }}</span>
              <span class="stat-label">NO (No Response)</span>
            </div>
            <div class="stat-card warning">
              <span class="stat-number">{{ reportStats.pending }}</span>
              <span class="stat-label">Pending</span>
            </div>
            <div class="stat-card">
              <span class="stat-number">{{ reportStats.total }}</span>
              <span class="stat-label">Total Evaluated</span>
            </div>
          </div>

          <!-- Filters -->
          <div class="report-filters">
            <label style="font-size: 13px; margin: 0;">Filter:</label>
            <select v-model="reportFilter" class="form-control" style="width: 150px;">
              <option value="all">All Decisions</option>
              <option value="yes">YES</option>
              <option value="no">NO</option>
              <option value="pending">Pending</option>
            </select>
            <button @click="loadReport" class="btn btn-default" :disabled="loadingReport">
              <span v-if="loadingReport">
                <span class="spinner spinner-sm"></span>
                Loading...
              </span>
              <span v-else>Refresh</span>
            </button>
          </div>

          <!-- Loading State -->
          <div v-if="loadingReport && reportLogs.length === 0" class="loading-spinner">
            <div class="spinner"></div>
            <p>Loading report data...</p>
          </div>

          <!-- No Data State -->
          <div v-else-if="!loadingReport && reportLogs.length === 0" class="no-data">
            No decisions evaluated yet
          </div>

          <!-- Report Table -->
          <div v-else>
            <div style="overflow-x: auto;">
              <table class="report-table">
                <thead>
                  <tr>
                    <th>Contact</th>
                    <th>Mobile Number</th>
                    <th>Original Message</th>
                    <th>Response</th>
                    <th>Decision</th>
                    <th>Evaluated At</th>
                  </tr>
                </thead>
                <tbody>
                  <tr v-for="log in filteredReportLogs" :key="log._id">
                    <td>{{ log.emailAddress || 'N/A' }}</td>
                    <td>{{ log.mobileNumber }}</td>
                    <td style="max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                      {{ log.message ? log.message.substring(0, 40) + '...' : 'N/A' }}
                    </td>
                    <td style="max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                      {{ log.responseMessage ? log.responseMessage.substring(0, 40) + '...' : '-' }}
                    </td>
                    <td>
                      <span class="decision-badge" :class="log.decisionStatus">
                        {{ log.decisionStatus }}
                      </span>
                    </td>
                    <td>{{ formatDate(log.decisionProcessedAt || log.sentAt) }}</td>
                  </tr>
                </tbody>
              </table>
            </div>

            <!-- Pagination -->
            <div class="pagination">
              <button @click="reportPage--" :disabled="reportPage <= 1" class="btn btn-default">
                Previous
              </button>
              <span>Page {{ reportPage }} of {{ totalPages }}</span>
              <button @click="reportPage++" :disabled="reportPage >= totalPages" class="btn btn-default">
                Next
              </button>
            </div>
          </div>
        </div>

        <button 
          id="btnSave" 
          type="button" 
          v-on:click="saveInstance()" 
          class="btn"
          v-bind:disabled="!isValid">
          SAVE CONFIGURATION
        </button>

        <div v-if="status.success || status.error" 
             v-bind:class="{ 'alert-success': status.success, 'alert-danger': status.error, 'in': fade }" 
             class="alert fade" 
             role="alert"
             style="margin-top: 20px;">
          {{ status.success || status.error }}
        </div>
      </form>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.11"></script>
    <script src="/eloqua-service/assets/js/axios.min.js"></script>

    <script type="text/javascript">
      var instance = <%-JSON.stringify(instance)%>;
      var consumer = <%-JSON.stringify(consumer)%>;

      var app = new Vue({
        el: '#receivesmsaction',
        data: {
          evaluation: Array.from({length: 168}, (_, i) => i + 1),
          instance: instance,
          consumer: consumer,
          status: {},
          fade: false,
          cdoConfig: {
            id: null,
            name: null,
            mobile_field: null,
            email_field: null,
            response_field: null,
            title_field: null,
            vn_field: null
          },
          // Report data
          reportLogs: [],
          reportStats: {
            yes: 0,
            no: 0,
            pending: 0,
            total: 0
          },
          reportFilter: 'all',
          reportPage: 1,
          reportLimit: 10,
          loadingReport: false
        },
        computed: {
          isValid: function() {
            if (!this.instance.evaluation_period) {
              return false;
            }
            if (this.instance.text_type === 'Keyword' && !this.instance.keyword) {
              return false;
            }
            return true;
          },
          hasCdoConfig: function() {
            return !!(this.consumer.actions && 
                     this.consumer.actions.receivesms && 
                     this.consumer.actions.receivesms.custom_object_id);
          },
          filteredReportLogs: function() {
            if (this.reportFilter === 'all') {
              return this.paginatedReportLogs;
            }
            var filtered = this.reportLogs.filter(log => log.decisionStatus === this.reportFilter);
            var start = (this.reportPage - 1) * this.reportLimit;
            return filtered.slice(start, start + this.reportLimit);
          },
          paginatedReportLogs: function() {
            var start = (this.reportPage - 1) * this.reportLimit;
            return this.reportLogs.slice(start, start + this.reportLimit);
          },
          totalPages: function() {
            var filtered = this.reportFilter === 'all' 
              ? this.reportLogs 
              : this.reportLogs.filter(log => log.decisionStatus === this.reportFilter);
            return Math.max(1, Math.ceil(filtered.length / this.reportLimit));
          }
        },
        watch: {
          reportFilter: function() {
            this.reportPage = 1;
          }
        },
        methods: {
          saveInstance() {
            var vm = this;

            if (!this.isValid) {
              this.showMessage('error', 'Please fill in all required fields');
              return;
            }

            const data = {
              instance: {
                evaluation_period: parseInt(vm.instance.evaluation_period),
                text_type: String(vm.instance.text_type),
                keyword: vm.instance.text_type === 'Keyword' ? vm.instance.keyword : null,
                SiteId: vm.consumer.SiteId,
                installId: vm.consumer.installId
              }
            };

            console.log('Saving decision config:', data);

            const btnSave = document.getElementById('btnSave');
            const originalText = btnSave.textContent;
            btnSave.textContent = 'SAVING...';
            btnSave.disabled = true;

            const options = {
              method: "POST",
              url: location.pathname + location.search,
              headers: { 'Content-Type': 'application/json' },
              data: JSON.stringify(data)
            };

            axios(options)
              .then(function(response) {
                vm.showMessage('success', 'Configuration successfully saved');
                
                setTimeout(() => {
                  if (window.opener) {
                    window.close();
                  }
                }, 2000);
              })
              .catch(function (error) {
                console.error('Save error:', error);
                var errorMsg = 'Failed to save configuration';
                if (error.response && error.response.data && error.response.data.message) {
                  errorMsg = error.response.data.message;
                }
                vm.showMessage('error', errorMsg);
              })
              .finally(function() {
                btnSave.textContent = originalText;
                btnSave.disabled = false;
              });
          },
          showMessage(type, message) {
            this.status = {};
            this.status[type] = message;
            this.fade = true;
            
            setTimeout(() => {
              this.fade = false;
              setTimeout(() => {
                this.status = {};
              }, 500);
            }, 3000);
          },
          loadCdoDetails() {
            var vm = this;
            
            if (!this.hasCdoConfig) {
              return;
            }

            const cdoId = this.consumer.actions.receivesms.custom_object_id;
            
            this.cdoConfig = {
              id: cdoId,
              name: 'Loading...',
              mobile_field: this.consumer.actions.receivesms.mobile_field || null,
              email_field: this.consumer.actions.receivesms.email_field || null,
              response_field: this.consumer.actions.receivesms.response_field || null,
              title_field: this.consumer.actions.receivesms.title_field || null,
              vn_field: this.consumer.actions.receivesms.vn_field || null
            };

            const options = {
              method: "GET",
              url: "/eloqua/decision/ajax/customobject/" + 
                   this.consumer.installId + "/" + 
                   this.consumer.SiteId + "/" + 
                   cdoId
            };

            axios(options)
              .then(function(response) {
                vm.cdoConfig.name = response.data.name || 'Unknown Custom Object';
              })
              .catch(function (error) {
                console.error('Error loading CDO details:', error);
                vm.cdoConfig.name = 'Custom Object (ID: ' + cdoId + ')';
              });
          },
          loadReport: function() {
            var vm = this;
            
            if (!vm.instance.instanceId) {
              return;
            }

            vm.loadingReport = true;

            axios.get('/eloqua/decision/report/' + vm.instance.instanceId)
              .then(function(response) {
                vm.reportLogs = response.data.logs || [];
                vm.reportStats = response.data.stats || {
                  yes: 0,
                  no: 0,
                  pending: 0,
                  total: 0
                };
                vm.loadingReport = false;
              })
              .catch(function(error) {
                console.error('Error loading report:', error);
                vm.loadingReport = false;
              });
          },
          formatDate: function(dateString) {
            if (!dateString) return '-';
            var date = new Date(dateString);
            return date.toLocaleString('en-US', {
              month: 'short',
              day: 'numeric',
              year: 'numeric',
              hour: '2-digit',
              minute: '2-digit'
            });
          }
        },
        mounted: function () {
          if (!this.instance.evaluation_period) {
            this.instance.evaluation_period = 1;
          }
          if (!this.instance.text_type) {
            this.instance.text_type = 'Anything';
          }

          this.loadCdoDetails();
          
          if (this.instance.instanceId) {
            this.loadReport();
          }
        }
      });
    </script>
  </body>
</html>